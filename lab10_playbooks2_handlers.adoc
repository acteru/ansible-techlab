# LAB10 - Ansible Playbooks

In this lab we'll get more used to using playbooks.

### Task 1
- Create a playbook `myhandler.yml` which does the following:
- Create a directory `newdir` in the folder `/home/ansible` of node1.
- if the folder didn't exist before, then do create a file `README.TXT` in this folder containing the text "This folder was created at <timestamp>"
- the value of timestamp should contain a quite accurate timestamp of when `ansible-playbook` was run.
- run the playbook several times to see if it is really idempotent.

[TIP]
====
 Remember to use facts. Be aware that there is not one single valid solution. Do decide yourself what you think solves the problem best.
====

### TASK 2
- Do extend your playbook to do the following:
- If the uptime of the server is higher than one hour, then do reboot the server.
- Run the playbook a second time. Is the reboot-task skipped now?

### TASK 3
- Create a playbook, that is run on all servers.
- The playbook should install the package `atop` on all servers that belong to a group that contain the letter `e` in its name.
- When the package wasn't installed before, then do also reboot the server.
- Run the playbook a several times again. Is the server booted again?


.Solution 1
[%collapsible]
====
Below is a possible solution for your playbook: 

[shell]
----
---
- hosts: node1
  become: yes
  tasks:
    - name: create directory
      file:
        path: /home/ansible/newdir
        state: directory
      notify: timestamp

  handlers:
    - name: create readme with timestamp 
      copy:
        dest: /home/ansible/techlab/newdir/README.TXT
        content: "This folder was created at {{ ansible_date_time.iso8601 }}"    
      listen: timestamp
----

If you are unsure how to run your playbook, then have a look at the earlier labs.
====


.Solution 2
[%collapsible]
====
Add the following task to your play
[shell]
----
    - name: reboot if longer than one hour up
      reboot:
      when: ansible_uptime_seconds >= '3600'
----
====

.Solution 3
[%collapsible]
====
[shell]
----
---
- hosts: all
  become: yes
  tasks:
    - name: install atop
      yum:
        name: atop
      notify: reboot
      when: "'web' in group_names"

  handlers:
    - name: reboot
      reboot:
----
====
